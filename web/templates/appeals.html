{% extends "base.html" %}

{% block title %}Обращения - Spasskaya Hotel Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-4"><i class="fas fa-envelope"></i> Обращения ({{ total_appeals }})</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Фильтры</h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="status" class="form-label">Статус</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Все статусы</option>
                            <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Новые</option>
                            <option value="received" {% if status_filter == 'received' %}selected{% endif %}>В работе</option>
                            <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Выполнено</option>
                            <option value="declined" {% if status_filter == 'declined' %}selected{% endif %}>Отклонено</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="room" class="form-label">Комната</label>
                        <input type="text" class="form-control" id="room" name="room" value="{{ room_filter or '' }}" placeholder="Номер комнаты">
                    </div>
                    <div class="col-md-4">
                        <label for="search" class="form-label">Поиск</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search_filter or '' }}" placeholder="Поиск по тексту или пользователю">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Поиск
                        </button>
                        <a href="/appeals" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Сброс
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="button" class="btn btn-outline-primary" id="selectAllBtn">
                    <i class="fas fa-check-square"></i> Выбрать все
                </button>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-success" id="bulkReceived" disabled>
                        <i class="fas fa-play"></i> В работу
                    </button>
                    <button type="button" class="btn btn-primary" id="bulkDone" disabled>
                        <i class="fas fa-check"></i> Выполнено
                    </button>
                    <button type="button" class="btn btn-danger" id="bulkDeclined" disabled>
                        <i class="fas fa-times"></i> Отклонено
                    </button>
                </div>
            </div>
            <div class="selected-count">
                <span id="selectedCount">0</span> выбрано
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th width="60">ID</th>
                                <th width="120">Пользователь</th>
                                <th width="80">Комната</th>
                                <th>Текст обращения</th>
                                <th width="100">Статус</th>
                                <th width="140">Дата</th>
                                <th width="120">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appeal in appeals %}
                            <tr class="appeal-row" data-appeal-id="{{ appeal.id }}">
                                <td>
                                    <input type="checkbox" class="form-check-input appeal-checkbox" value="{{ appeal.id }}">
                                </td>
                                <td>{{ appeal.id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-circle me-2 text-muted"></i>
                                        @{{ appeal.username }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ appeal.room }}</span>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 300px;" title="{{ appeal.text }}">
                                        {{ appeal.text }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{% if appeal.status == 'new' %}warning{% elif appeal.status == 'received' %}info{% elif appeal.status == 'done' %}success{% else %}danger{% endif %}">
                                        {% if appeal.status == 'new' %}Новое
                                        {% elif appeal.status == 'received' %}В работе
                                        {% elif appeal.status == 'done' %}Выполнено
                                        {% else %}Отклонено
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ appeal.created_at.strftime('%d.%m.%Y') }}<br>
                                        {{ appeal.created_at.strftime('%H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="/appeals/{{ appeal.id }}" class="btn btn-sm btn-outline-primary" title="Открыть">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="fas fa-cogs"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item status-btn" href="#" data-appeal-id="{{ appeal.id }}" data-status="received">
                                                    <i class="fas fa-play text-info"></i> В работу
                                                </a></li>
                                                <li><a class="dropdown-item status-btn" href="#" data-appeal-id="{{ appeal.id }}" data-status="done">
                                                    <i class="fas fa-check text-success"></i> Выполнено
                                                </a></li>
                                                <li><a class="dropdown-item status-btn" href="#" data-appeal-id="{{ appeal.id }}" data-status="declined">
                                                    <i class="fas fa-times text-danger"></i> Отклонено
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if total_pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if current_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ current_page - 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Previous</a>
                    </li>
                {% endif %}

                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == current_page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% elif page_num == 1 or page_num == total_pages or (page_num >= current_page - 2 and page_num <= current_page + 2) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">{{ page_num }}</a>
                        </li>
                    {% elif page_num == current_page - 3 or page_num == current_page + 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if current_page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ current_page + 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if room_filter %}&room={{ room_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
let selectedAppeals = new Set();

document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.appeal-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
        if (this.checked) {
            selectedAppeals.add(parseInt(cb.value));
        } else {
            selectedAppeals.delete(parseInt(cb.value));
        }
    });
    updateBulkButtons();
});

document.querySelectorAll('.appeal-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            selectedAppeals.add(parseInt(this.value));
        } else {
            selectedAppeals.delete(parseInt(this.value));
        }
        updateBulkButtons();
        
        const allCheckboxes = document.querySelectorAll('.appeal-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.appeal-checkbox:checked');
        document.getElementById('selectAll').checked = allCheckboxes.length === checkedCheckboxes.length;
    });
});

function updateBulkButtons() {
    const count = selectedAppeals.size;
    document.getElementById('selectedCount').textContent = count;
    
    const bulkButtons = ['bulkReceived', 'bulkDone', 'bulkDeclined'];
    bulkButtons.forEach(id => {
        document.getElementById(id).disabled = count === 0;
    });
}

document.getElementById('bulkReceived').addEventListener('click', () => bulkUpdateStatus('received'));
document.getElementById('bulkDone').addEventListener('click', () => bulkUpdateStatus('done'));
document.getElementById('bulkDeclined').addEventListener('click', () => bulkUpdateStatus('declined'));

document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const appealId = parseInt(this.dataset.appealId);
        const status = this.dataset.status;
        updateSingleStatus(appealId, status);
    });
});

function bulkUpdateStatus(status) {
    if (selectedAppeals.size === 0) return;
    
    const appealIds = Array.from(selectedAppeals);
    
    fetch('/api/appeals/bulk_update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            appeal_ids: appealIds,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Статус обновлен для ' + data.updated_count + ' обращений', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        showAlert('Ошибка при обновлении статуса', 'error');
    });
}

function updateSingleStatus(appealId, status) {
    const formData = new FormData();
    formData.append('status', status);
    
    const button = event.target.closest('.dropdown-item');
    if (button) {
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Загрузка...';
    }
    
    fetch(`/api/appeals/${appealId}/status`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Статус обращения #${appealId} изменен на "${getStatusText(status)}"`, 'success');
            updateRowStatus(appealId, status);
        } else {
            showAlert('Ошибка при обновлении статуса', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Ошибка сети', 'error');
    })
    .finally(() => {
        if (button) {
            setTimeout(() => {
                const icon = button.querySelector('i').className;
                const text = getStatusText(status);
                button.innerHTML = `<i class="${icon}"></i> ${text}`;
            }, 1000);
        }
    });
}

function updateRowStatus(appealId, status) {
    const row = document.querySelector(`tr[data-appeal-id="${appealId}"]`);
    if (row) {
        const badge = row.querySelector('.badge');
        badge.className = `badge bg-${getStatusColor(status)}`;
        badge.textContent = getStatusText(status);
    }
}

function getStatusColor(status) {
    const colors = {
        'new': 'warning',
        'received': 'info', 
        'done': 'success',
        'declined': 'danger'
    };
    return colors[status] || 'secondary';
}

function getStatusText(status) {
    const texts = {
        'new': 'Новое',
        'received': 'В работе',
        'done': 'Выполнено',
        'declined': 'Отклонено'
    };
    return texts[status] || status;
}

function showAlert(message, type) {
    const alertDiv = document.getElementById('statusAlert');
    const messageSpan = document.getElementById('statusMessage');
    
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    messageSpan.textContent = message;
    alertDiv.style.display = 'block';
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}